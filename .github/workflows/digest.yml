name: Daily Digest

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: zc_forum
        ports: ['5432:5432']
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.89
      - name: Install and start Ollama
        run: |
          curl -L https://ollama.ai/install.sh | sh
          ollama serve >/tmp/ollama.log 2>&1 &
          until curl -s http://127.0.0.1:11434/api/version >/dev/null; do
            sleep 1
          done
      - name: Build Ollama model
        run: |
          ollama create zc-forum-summarizer -f Modelfile
          ollama run zc-forum-summarizer "ping" >/tmp/ollama-warmup.log
      - name: Wait for DB
        run: |
          # Wait for PostgreSQL to become ready, with exponential backoff (max 60s)
          for i in 1 2 3 4 5 6; do
            if pg_isready -h 127.0.0.1 -p 5432 -U postgres; then
              break
            fi
            sleep $((2 ** i))
          done
      - name: Database migrations with sqlx
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/zc_forum
        run: |
          cargo install sqlx-cli --no-default-features --features postgres
          sqlx migrate run
      - name: Run ETL
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/zc_forum
          LLM_MODEL: zc-forum-summarizer
          OLLAMA_BASE_URL: http://127.0.0.1:11434
        run: |
          cargo run --release --bin zc-forum-etl
      - name: Generate digest
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/zc_forum
        run: cargo run --release --bin digest
      - name: Setup Pages
        uses: actions/configure-pages@v4
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - name: Deploy to Pages
        id: deploy
        uses: actions/deploy-pages@v4
